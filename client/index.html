<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
  	<title>WebAuthn sample</title>
</head>
<body>

	<form id="registerForm" action="javascript:register()">
		<label for="username">Username<label>
		<input type="text" id="username" name="username">

		<input type="submit" id="submitRegistration" name="submitRegistration" value="Register">
	</form>

	<br>
	<br>

	<div id="step_2" style="display: none">
		<form id="authenticateForm" action="javascript:authenticate()">
			<div>Registered Users:</div>
			<div id="registredUserInfo"></div>
			<br>
			<input type="submit" id="submitAuthentication" name="submitAuthentication" value="Authenticate">
		</form>
	</div>

	<br>

	<div id="step_ok" style="display: none">
		<div>Authentication OK!</div>
		<span>Authenticated User:</span>&nbsp;
		<span id="authenticatedUsername"></span>&nbsp;-&nbsp;
		<span id="authenticatedRawID"></span>
	</div>

	<div id="step_ko" style="display: none">
		<div>Authentication KO... refresh page and retry</div>
	</div>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
	<script src="https://unpkg.com/cbor-js-unofficial@0.1.0-a4/cbor.js"></script>
	<script>


		//////////////////////////////////////////////////// REGISTRATION AND AUTHENTICATION
		function register(){
			const username = getInputValue('username');
			const registrationParams = serverInitRegistration(username);
			navigator.credentials.create({
			    publicKey: {
			      // random, cryptographically secure, at least 16 bytes
			      challenge: registrationParams.challenge,
			      // relying party
			      rp: {
			        name: "localhost", // sample relying party
			      },
			      user: {
			        id: registrationParams.userId,
			        name: registrationParams.name,
			        displayName: registrationParams.name,
			      },
			      authenticatorSelection: { userVerification: "preferred" },
			      pubKeyCredParams: [{
			          type: "public-key",
			          alg: -7, // "ES256" IANA COSE Algorithms registry
			      }],
			      attestation: 'direct'
			    },
			  })
			  .then((credential) => {
			  	console.log(credential)

			    const utf8Decoder = new TextDecoder('utf-8');
          const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON)
          const clientDataObj = JSON.parse(decodedClientData);
          console.log(clientDataObj)

          const decodedAttestationObj = CBOR.decode(credential.response.attestationObject);
          console.log(decodedAttestationObj);

          const authData = Array.from(decodedAttestationObj.authData)
            .map(x => x.toString(16).padStart(2, '0'))
            .join('')
          console.log(authData)

          const user = serverRegister(registrationParams.id, credential, registrationParams.challenge);
          createUserInfo(user);
          setCssValue('step_2', 'display', 'block');
			  })
			  .catch(err => {
			  	console.error(err);
			  	alert(err);
			  });
		}

		function authenticate(){
			const userId = getIdUserSelected();
			if(!userId) return;
			const authParams = serverInitAuthentication(parseInt(userId));
			navigator.credentials.get({
          publicKey: {
            challenge: authParams.challenge,
            allowCredentials: [{
                id: authParams.credentialRawId,
                type: 'public-key'
            }],
            timeout: 5000,
            userVerification: "discouraged"
          }
        })
        .then(attestation => {
          console.log(attestation);
          authenticatedUser = serverAuthenticate(authParams.id, attestation, authParams.challenge);
          setValue('authenticatedUsername', authenticatedUser.name);
          setValue('authenticatedRawID', authenticatedUser.credentialId);
          setCssValue('step_ok', 'display', 'block');
        })
        .catch(err => {
          setCssValue('step_ko', 'display', 'block');
          console.error(err);
          alert(err);
        });
		}




		//////////////////////////////////////////////////// MOCK SERVER WEBAUTHN
		let registeredUsers = [];
		let authenticatedUser;

		function serverInitRegistration(username){
			const user = {
				id: registeredUsers.length,
				name: username,
				challenge: generateChallenge()
			};
			registeredUsers.push(user);
			return {
				id: user.id,
				userId: generateUserId(),
				name: username,
				challenge: user.challenge,
			};
		}

		function serverRegister(id, credential, challenge){
			const user = registeredUsers.find(x => x.id === id);
			
			// check challenge
			if(user.challenge !== challenge){
				alert("Wrong challenge");
				throw { message: "Wrong challenge" };
			}
			delete user.challenge;
			
			// update credential
			user.credentialId = credential.id;
			user.credentialRawId = credential.rawId;
			
			return user;
		}

		function serverInitAuthentication(id){
			const user = registeredUsers.find(x => x.id === id);
			user.challenge = generateChallenge();
			return {
				id: user.id,
				challenge: user.challenge,
				credentialRawId: user.credentialRawId,
				credentialId: user.credentialId
			};
		}

		function serverAuthenticate(id, attestation, challenge){
			const user = registeredUsers.find(x => x.id === id);

			// check challenge
			if(user.challenge !== challenge){
				alert("Wrong challenge");
				throw { message: "Wrong challenge" };
			}
			delete user.challenge

			return user;
		}



		//////////////////////////////////////////////////// HELPERS
		function createUserInfo(user){
			appendValue('registredUserInfo', '<input type="radio" id="' + user.id + '" name="chooseUser" checked>')
			appendValue('registredUserInfo', '<label for="' + user.id + '"> &nbsp;' + user.name + ' &nbsp;-&nbsp; ' + user.credentialId + ' </label>')
			appendValue('registredUserInfo', '<br>')
		}

		function getIdUserSelected(){
			return getRadioSelected('chooseUser', 'authenticateForm', () => alert('User not selected'));
		}

		function getRadioSelected(radionName, formName, errCall){
			let res = $('input[name=' + radionName + ']:checked', '#' + formName)[0];
			if(!res && errCall){
				errCall();
				return null;
			}
			return res.id;
		}

		function generateUserId(){
			let str = randomString(32);
			let result = Uint8Array.from(str, c => c.charCodeAt(0));
			console.log("Generated UserId:", result);
			return result;
		}

		function generateChallenge(){
			let str = randomString(32);
			let result = Uint8Array.from(str, c => c.charCodeAt(0));
			console.log("Generated Challenge:", result);
			return result;
		}

		function randomString(length){
			let result = '';
		    let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		    let charactersLength = characters.length;
		    for (let i = 0; i < length; i++) {
		    	result += characters.charAt(Math.floor(Math.random() * charactersLength));
		    }
		    return result;
		}

		function getInputValue(id){
			return $("#" + id).val();
		}

		function setValue(id, value){
			$("#" + id).text(value);
		}

		function setCssValue(id, prop, val){
			$("#" + id).css(prop, val);
		}

		function appendValue(id, value){
			$("#" + id).append(value);
		}
	</script>
</body>
</html>